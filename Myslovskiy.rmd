---
title: "ДЗ. Пожары в Португалии"
author: "Павел Мысловский, БЭК171 (Матвей, выздоравливай!)"
output:
    pdf_document:
        keep_tex: yes
header-includes:
   - \usepackage[T2A]{fontenc}
   - \usepackage[utf8]{inputenc}
   - \usepackage[russian]{babel}
---


```{r}
library(car)
library(lmtest)
library(dynlm)
library(sandwich)
library(tidyr)
library(dplyr)
library(ggplot2)
library(purrr)
library(tidyr)
library(pastecs)
library(stargazer)
library(glmnet)
library(fastDummies)

```

№1. Загружаем данные, нулевые значения для area фильтруем. Переменные month и day преобразовываем. 

```{r}
data <- read.csv('https://archive.ics.uci.edu/ml/machine-learning-databases/forest-fires/forestfires.csv', header = TRUE)
set.seed(14)
```
```{r echo=TRUE}
data <- data[which(data$area != 0), ]
data$month <- as.factor(data$month)
data$day <- as.factor(data$day)
```


№2 
Отбираем признаки: 
-Берем переменные, характеризующие основные погодные условия:temp,wind,RH,rain
-Добавляем дополнительные переменные, представляющие комбинации основных переменных, которые также могут быть полезны для выявления нелинейных признаков:DMC, DC, FFMC, ISI. Отметим, что эти индексы являются различными комбинациями основных погодных показателей, в связи с чем можно ожидать наличие мультиколлинеарности.

Характеристика переменных и гипотезы о знаках:

temp: характеризует температуру. Более высокая температура воздуха приводит к увеличению вероятности пожаров, поэтому ожидается положительная взаимосвязь.

wind: характеризует скорость ветра. Более высокая скорость ветра приводит к увеличению площади пожаров, поскольку ветер способствует раздуванию пожара и его более стремительному распространению. Ожидается положительная взаимосвязь.

RH: характеризует  влажность. Более высокая влажность уменьшает вероятность пожара, поэтому знак ожидается отрицательный. При этом влажность специфична для каждого  сезона и температурных условий, поэтому имеет смысл взять пересечение этих факторов.

rain: характеризует количество дождя. Большее количество дождя снижает вероятность пожаров, знак при  этой переменной ожидается отрицательный. Эта переменная имеет только 2 ненулевых значения, в связи с чем она является малополезной и в регрессиях она не будет использоваться.

DMC: индекс, характеризующий влажность веществ в нижних слоях почвы, который увеличивается при росте вероятности пожара(т.е. растер с понижением влажности веществ), поэтому взаимосвязь ожидается положительная. Средние слои почвы оказывают большое влияние на скорость распространения пожаров.

DC: индекс, характеризующий влажность веществ в средних слоях почвы, который увеличивается при росте вероятности пожара(т.е. растер с понижением влажности веществ), поэтому взаимосвязь ожидается положительная. Аналогично оказывает влияние на скорость распространения пожаров, однако в основном важен для более крупных пожаров, т.к. воспламенение нижних слоев происходит в последнюю очередь.

FFMC: общий индекс, характеризующий  вероятность возгорания, опираясь на показатели влажности. Положительно связан с вероятностью, следовательно взаимосвязь ожидается положительная.

ISI: комплексная оценка скорости распространения пожара, которая включает в себя предыдущие индексы, а также учитывающая показатель скорости ветра. Взамосвязь ожидается положительная. 

Кроме того, охарактеризуем переменные контроля:

day: вероятно, в выходные вероятность пожаров возрастает, поскольку люди более склонны отдыхать на природе, а пожарные хотят отдыхать.

month: скорее всего наибольшие площади пожаров будут наблюдаться летом, когда в Португалии наиболее жарко.

Описательная статистика по  переменным:
```{r}
data <- data[,-c(1,2)]
res <- stat.desc(data[, -c(1:2)])
round(res, 2)
res
```

У многих переменных распределение похоже на нормальное или близкое к нему. При этом, гипотеза о нормальности распределения в тесте Шапиро-Уилка отвергается для всех переменных. Это может объясняться тем, что были убраны  важные для нормальности диапазоны значений объясняющих переменных, поскольку мы рассматриваем  непосредственно периоды возгарания.

Рассмотрим выделяющиеся аспекты:

-RH: распределение смещено в сторону низких значений, что может быть вызвано тем фактом, что большинство пожаров возникают при невысококом уровне влажности.

-month: значительная доля пожаров происходит в августе и сентябре, что подтверждает выдвинутую ранее гипотезу.

-day: здесь также подтверждается выдвинутое ранее предположение, о преобладании пожаров в выходные и пятницу 

```{r}
#Гистограммы
g <- data %>%
  keep(is.numeric) %>%                     
  gather() %>%                             
  ggplot(aes(value)) +                     
    facet_wrap(~ key, scales = "free") +   
    geom_histogram() 
g <- g + labs(title = "Гистограммы распределения", x = "Значение переменной", y = "Число возгораний")
g

#Плотности
g1 <- data %>%
  keep(is.numeric) %>%                     
  gather() %>%                             
  ggplot(aes(value)) +                     
    facet_wrap(~ key, scales = "free") +   
    geom_density()
    
g1 <- g1 + labs(title = "Плотности распределения", x = "Значение переменной", y = "Оценка плотности")
g1

#Шапиро
lapply(data[,-c(1,2)], shapiro.test)

#По месяцам
ggplot(data, aes(x = month)) + 
  geom_bar() +
  labs(title = "Распределение пожаров в зависимости от месяца",y = "Число пожаров", x = "Месяц")


#По дням
ggplot(data, aes(x = day)) + 
  geom_bar() +
  labs(title = "Распределение пожаров в зависимости от дня недели",y = "Число пожаров", x = "День недели")

```

Смотрим на ящики(с усами) для оценки выбросов. Нетрудно заметить, что наиболее большие outliers наблюдаются для площади пожаров, количества осадков и для индексов. В случае с индексами, удаление выбросов не производится поскольку их их сложно интерпретировать в связи с методологией подсчета индексов.

Для площади пожаров имеется 2  наблюдения с очень большой площадью, что может исказить результаты, следовательно их мы удаляем. 
Для количества осадков также убираем 2 наблюдения, в которых осадки не равны 0.
```{r}
#boxplot
g <- data %>%
  keep(is.numeric) %>%                     
  gather() %>%                             
  ggplot(aes(x="",y=value)) +                     
    facet_wrap(~ key, scales = "free") +   
    geom_boxplot() 
g <- g+labs(title = "Ящики (с усами) для распределения переменных ", x = "", y = "Значение переменной")
g

#Считаем выбросы и чистим 
summary(data)
count(data[which(data$rain > 0),])
count(data[which(data$area > 300),])
data <- data[which(data$area < 300 & data$rain == 0),]

```
№3
Проверяем мультиколлинеарность с помощью VIF и CN.  Оценено три спецификации модели, для более полного понимания присутствия эффекта мультиколллинеарности.


```{r}
set.seed(14)
#Убираем осадки
data <- data[,-c(10)] 
#Специфицируем модели
#Базовая на все природные факторы
mod1 <- lm(area~RH +temp+wind, data)
#Добавляем индексы
mod2 <- lm(area~. -month -day, data)
#Добавляем переменные дня и месяца
mod3 <- lm(area~.,data)

#Мультиколлинеарность

#Модель 1
vif(mod1)
kappa(mod1)

#Модель 2
vif(mod2)
kappa(mod2)

#Модель 3
vif(mod3)
kappa(mod3)

#LASSO 

#Модель 1
m1 = as.matrix(data[,7:9]) 
lasso1 <- cv.glmnet(x = m1, y = data$area, type.measure = "mse",family = 'gaussian', alpha = 1) #оцениваем лямбду
lambda1 <- lasso1$lambda.min
coef1 <- lasso1$glmnet.last$beta[,lasso1$glmnet.last$lambda == lambda1] 
coef1
#Сравниваем lasso и  обычную модель
mean((data$area - predict(lasso1,s = lambda1,newx = m1))^2) 
mean((mod1$residuals)^2)

#Модель 2
m2 = as.matrix(data[,3:9]) 
lasso2 <- cv.glmnet(x = m2, y = data$area, type.measure = "mse",family = 'gaussian', alpha = 1) #оцениваем  лямбду
lambda2 <- lasso2$lambda.min 
coef2 <- lasso2$glmnet.last$beta[,lasso2$glmnet.last$lambda == lambda2] 
coef2
#Сравниваем lasso и  обычную модель
mean((data$area - predict(lasso2,s = lambda2,newx = m2))^2) 
mean((mod2$residuals)^2) 

#Модель 3
m3 = as.matrix(dummy_cols(data[,1:9])[,-c(1:2,9,23)]) #исключена жесткая мультиколлинеарность
lasso3 <- cv.glmnet(x = m3, y = data$area, type.measure = "mse",family = 'gaussian', alpha = 1) #оцениваем лямбду
lambda3 <- lasso3$lambda.min 
coef3 <- lasso3$glmnet.last$beta[,lasso3$glmnet.last$lambda == lambda3] 

#Сравниваем lasso и  обычную модель
mean((data$area - predict(lasso3,s = lambda3,newx = m3))^2) 
mean((mod3$residuals)^2) 
```
Тесты показывают, что мультиколлинеарность есть, поскольку собственные значения матрицы достаточно маленькие, а при добавлении переменных контроля и VIF становится большим. 

Для избавления от нее можно применить LASSO. Результаты LASSO по 4 спецификациям:
модель (RH, temp, wind):коэффициенты 0
модель (все регрессоры): коэффициенты 0
А вот для модели с включением индексов и без контрольных переменных наблюдается ненулевые коэффициенты. 
Итогом анализа становится вывод, что надо оценивать модель с переменными temp, RH, ISI, DMC, поскольку у этих переменных ненулевые коэффициенты. 


№4
Оценка линейной модели. После проверки мультиколлинеарности остались следующие регрессоры: temp, ISI, DMC,  RH). 

```{r}
set.seed(14)

#Итоговая модель
last <- lm(area~DMC+ISI+temp+RH, data)
summary(last)


#Интерпретация

stargazer(last,title="Зависимость площади пожара от природных факторов", type="text", 
                                        column.labels=c("Итоговая модель"), 
                                        df=FALSE, digits=3)

#Нормальность остатков через Шапиро
shapiro.test(last$residuals)
```
Интерпретируем коэффициенты: значимым является только коэффициент при ISI, поэтому интерпретируем его.

ISI: оказывается, что наблюдается отрицательная взаимосязь между этим фактором и площадью пожаров, что конфликтует с ранее озвученной гипотезой. Это может объясняться тем, что выделение пожарных сил в соответствии с этим индексом неэффективно, поскольку низкий индекс распространения, в итоге приводит к тому, что на пожар выделяется недостаточно средств, что приводит к его распространению  

Тест Шапиро-Уилка отвергает гипотезу, следовательно гипотезы и д.и. некорректно посчитаны.


№5. Построим необходимые прогнозы: точечный, индивидуальный и для среднего.
```{r}
nw <- data.frame(DMC = median(data$DMC),ISI = median(data$ISI), temp= median(data$temp), RH = median(data$RH))
head(nw)
predict(last, newdata = nw, interval = 'prediction')
predict(last, newdata = nw, interval = 'confidence')
```
№6.
Гетероскедастичность можно ожидать по следующим переменным:

- temp: ошибки, вероятно, будут расти с ростом температуры, поскольку если в относительно холодное время пожары не разрастаются сильно, то во время высокой температуры пожары могут достигать больших размеров, а другие факторы сильнее влияют

- RH: можно ожидать, что отклонения будут падать с ростом влажности, поскольку в ситуации высокой влажности воздуха, распространение пожаров ограничено, а другие факторы будут оказывать несильное влияние

- DMC: ошибки, вероятно, будут расти с ростом влажности в средних слоях, поскольку при низких значениях, шанс того, что возникнет пожар намного меньше, чем при высоком, когда другие факторы смогут существенно повлиять на масштабы этого пожара

- ISI: для этого индекса  можно ожидать наиболее высокого разброса в середине распределения

№7.

Попробуем выявить гетероскедастичность графически с помощью остатков регрессионной модели и с помощью теста Голдфельда-Квандта.


```{r}
#Графики
ggplot(data = data, aes(x=ISI, y=last$residuals)) +
 geom_point() +
 labs(title = "Зависимость остатков от индекса распространения пламени ISI",y = "Остатки модели last, га")
ggplot(data = data, aes(x = temp, y = last$residuals)) +
 geom_point() +
 labs(title = "Зависимость остатков от температуры воздуха",y = "Остатки модели last, га", x = "Температура, градусы")
ggplot(data = data, aes(x=RH, y=last$residuals)) +
 geom_point() +
 labs(title = "Зависимость остатков от относительной влажности",y = "Остатки модели last, га",x = "Относительная влажность воздуха, %")
ggplot(data = data, aes(x = DMC, y = last$residuals)) +
 geom_point() +
 labs(title = "Зависимость остатков от индекса влажности почвы DMC",y = "Остатки модели last, га")


#Гольдфельд-Квандт 

m = 0.2#срединная доля
#Для temp
gqtest(last, fraction = m, alternative = c("greater"),
  order.by = data$temp)
gqtest(last, fraction = m, alternative = c("less"),
  order.by = data$temp)
gqtest(last, fraction = m, alternative = c("two.sided"),
  order.by = data$temp)
#Для RH
gqtest(last, fraction = m, alternative = c("greater"),
  order.by = data$RH)
gqtest(last, fraction = m, alternative = c("less"),
  order.by = data$RH)
gqtest(last, fraction = m, alternative = c("two.sided"),
  order.by = data$RH)
#Для  DMC
gqtest(last, fraction = m, alternative = c("greater"),
  order.by = data$DMC)
gqtest(last, fraction = m, alternative = c("less"),
  order.by = data$DMC)
gqtest(last, fraction = m, alternative = c("two.sided"),
  order.by = data$DMC)
#Для ISI
gqtest(last, fraction = m, alternative = c("greater"),
  order.by = data$ISI)
gqtest(last, fraction = m, alternative = c("less"),
  order.by = data$ISI)
gqtest(last, fraction = m, alternative = c("two.sided"),
  order.by = data$ISI)

```
Проверка показывает, что гетероскедастичность присутствует по любой переменной. Выдвинутые ранее гипотезы подтвердились: графически для temp и DMC остатки сильнее колеблются при высоких значениях, для RH - при низких, для ISI -посередине.
Результаты теста Гольдфельда-Квандта показывают, что при изымаемой доле в 0.2, для индексов на 1% уровне значимости отвергается гипотеза для отсутствия гетероскедастичности.


№8
Оценена модель взвешенного МНК, основанная на предположении о зависимости остатков от оценённых в изначальной модели. 

```{r}

#ВМНК
weights1 <- 1/abs(lm(last$residuals^2~last$fitted.values)$fitted.values)
WOLS1 <- lm(area~DMC+ISI+temp+RH, data, weights = weights1 )
summary(WOLS1)

#Сравнение
stargazer(last,WOLS1,title = "Сравнение МНК и ВМНК",type="text", 
                                        column.labels = c("МНК", "Взвешенный МНК"), 
                                        df=FALSE, digits=3)

```
На основе этого анализа можно сделать выводы, что много переменных не учтено (раз константа значимая), а также что стоит более реалистичные предположения наложить на матрицу ковариации случайных ошибок.

№9. 

Далее представлены оценки HC0 и HC3. Значимость  коэффициента индекса ISI возросла в сравнении с обычными МНК, для остальных не изменилась.
```{r}

#HC0 
hc = function(reg) {
  sqr = sqrt(diag(vcovHC(reg, type = "HC0")))
  return(sqr)
}
hc(last)

#Статистика для HC0
coeftest(last, vcov = vcovHC(last, type = "HC0"))

#HC3 
hc1 = function(reg) {
  sqr = sqrt(diag(vcovHC(reg, type = "HC3")))
  return(sqr)
}

#Представление модели в таблице с ошибками HC0 и HC3
stargazer(last, last,last,   
          se=list(hc(last),hc1(last)), 
          title="Сравнение стандартных ошибок", type="text", 
          column.labels=c("HC0","HC3"), report = "vcstp*",
          df=FALSE, digits=3)
```

№10

Преобразование с помощью PCA. 
```{r}
set.seed(14)
#выделяем главные компоненты
dfpca <- prcomp(data[c(4,6:8)], center = TRUE,scale. = TRUE)

#Записываем 1 и 2-ю компоненты
x1 <- dfpca$x[,1]
x2 <- dfpca$x[,2]
#Доли дисперсии через summary смотрим
summary(dfpca)

#модель
model <- lm(data$area ~ x1+x2)
summary(model)
stargazer(model,title = "Регрессия на главные компоненты",type="text", 
                                        column.labels=c("МНК"), 
                                        df=FALSE, digits=3)
```
Объясняемые первыми двумя компонентами доли дисперсии составляют суммарно больше 3/4, что говорит о том, что модель объясняет большую долю дисперсии. Все коэффициенты являются значимыми. 



